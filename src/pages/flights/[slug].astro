---
import { DateTime, Duration } from "luxon";
import Layout from "../../layouts/Layout.astro";
import FlightCard from "../../components/FlightCard.astro";
import TripMap from '../../components/LeafletTrip.jsx';
import { getAllFlights, slugForFlight, getAirlineInfo, getAirportInfo } from "../../lib/db";

export async function getStaticPaths() {
  const flights = getAllFlights();
  return flights.map((f) => ({ params: { slug: slugForFlight(f) } }));
}

const slug = Astro.params.slug as string;

// parse slug back into number+date; this assumes date has fixed format like YYYY-MM-DD
// If date isn't fixed-length, adjust parsing logic or change slug format.
let flight,
  airline,
  dept_airport,
  arrival_airport,
  dept_difference,
  dept_difference_class,
  arrival_difference,
  arrival_difference_class,
  scheduled_time,
  actual_time,
  status,
  status_class = null,
  stops = [];
// try to find by matching prefix number and suffix date by scanning flights
const all = getAllFlights();
for (const f of all) {
  if (slugForFlight(f) === slug) {
    flight = f;
    break;
  }
}

if (!flight) {
  throw new Error(`Flight not found for slug: ${slug}`);
}

if (flight.airline_code) {
  airline = getAirlineInfo(flight.airline_code);
}

if (flight.dept_airport) {
  dept_airport = getAirportInfo(flight.dept_airport);
  stops.push({name:dept_airport.name, abbr: dept_airport.abbreviation, lat: dept_airport.lat, lng: dept_airport.long})
}



if (flight.arrival_airport) {
  arrival_airport = getAirportInfo(flight.arrival_airport);
  stops.push({name:arrival_airport.name, abbr: arrival_airport.abbreviation, lat: arrival_airport.lat, lng: arrival_airport.long})
}


let dept_gate_scheduled = DateTime.fromISO(flight.dept_gate_scheduled, {
  zone: dept_airport?.timezone,
});

let dept_gate_actual = DateTime.fromISO(flight.dept_gate_actual, {
  zone: dept_airport?.timezone,
});

let arrival_gate_scheduled = DateTime.fromISO(flight.arrival_gate_scheduled, {
  zone: arrival_airport?.timezone,
});

let arrival_gate_actual = DateTime.fromISO(flight.arrival_gate_actual, {
  zone: arrival_airport?.timezone,
});

if (dept_gate_scheduled && dept_gate_actual) {
  // both times are valid
  dept_difference = dept_gate_actual.diff(dept_gate_scheduled, ["minutes"]);
  if(dept_difference.minutes <= 15) {
    dept_difference_class = "on-time";
  } else {
    dept_difference_class = "delayed";
  }
}

if (arrival_gate_scheduled && arrival_gate_actual) {
  arrival_difference = arrival_gate_actual.diff(arrival_gate_scheduled , ["minutes"]);
  if(arrival_difference.minutes <= 15) {
    arrival_difference_class = "on-time";
  } else {
    arrival_difference_class = "delayed";
  }
}

if (dept_gate_scheduled && arrival_gate_scheduled) {
  // both times are valid
  scheduled_time = arrival_gate_scheduled.diff(dept_gate_scheduled, ["hours", "minutes"]);
}

if (dept_gate_actual && arrival_gate_actual) {
  // both times are valid
  actual_time = arrival_gate_actual.diff(dept_gate_actual, ["hours", "minutes"]);
}

if (actual_time && scheduled_time) {
  // both times are valid
  if (actual_time <= scheduled_time) {
    status_class = "on-time";
  } else {
    status_class = "on-time";
  }
}
---

<Layout title={`${flight.number} - ${dept_gate_scheduled.toFormat("M/d/yyyy")}`}>
  <link slot="head" rel='stylesheet' href='https://unpkg.com/leaflet@1.8.0/dist/leaflet.css' integrity='sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ==' crossorigin='' />
  <div class="blog-content content-container">
    <div class="flights-container">
      <h1 class="airline-header">
        <span>{airline.name} - {flight.number}</span><span>{dept_gate_scheduled.toFormat("M/d/yyyy")}</span>
      </h1>
      <div class="flights">
        <div class="departure">
          <FlightCard
            airport_name={dept_airport.name}
            ,
            airport_code={flight.dept_airport}
            ,
            scheduled_time={dept_gate_scheduled}
            ,
            actual_time={dept_gate_actual}
            ,
            terminal={flight.dept_terminal}
            ,
            gate={flight.dept_gate}
          />
        </div>
        <div class="flight-line-container">
          <div class="flight-line"></div>
          <div class="plane-icon">‚úàÔ∏è</div>
        </div>
        <div class="arrival">
          <FlightCard
            airport_name={arrival_airport.name}
            ,
            airport_code={flight.arrival_airport}
            ,
            scheduled_time={arrival_gate_scheduled}
            ,
            actual_time={arrival_gate_actual}
            ,
            terminal={flight.arrival_terminal}
            ,
            gate={flight.arrival_gate}
          />
        </div>
      </div>
      <div class="stripe-container"></div>
    </div>

    <div class="details-container">
      <div class={`${arrival_difference_class} status-header`}>{flight.status}</div>
      <div class="details-times">
        <div class="times">
          <h3>Scheduled</h3>
          <div class="detail-item">
            <div class="icon">üõ´</div>
            <div class="detail-content">
              <div class="detail-label">Gate Departure</div>
              <div class="detail-value">
                {dept_gate_scheduled.toFormat("h:mm a ZZZZ")} 
              </div>
            </div>
          </div>
          <div class="detail-item">
            <div class="icon">üõ¨</div>
            <div class="detail-content">
              <div class="detail-label">Gate Arrival</div>
              <div class="detail-value">
                {arrival_gate_scheduled.toFormat("h:mm a ZZZZ")}
              </div>
            </div>
          </div>
          {
            scheduled_time && (
              <div class="detail-item">
                <div class="icon">‚è±Ô∏è</div>
                <div class="detail-content">
                  <div class="detail-label">Duration</div>
                  <div class="detail-value">
                    {scheduled_time.hours}h {scheduled_time.minutes}m{" "}
                  </div>
                </div>
              </div>
            )
          }
        </div>
        <div class="times">
          <h3>Actual</h3>
          <div class="detail-item">
            <div class="icon">üõ´</div>
            <div class="detail-content">
              <div class="detail-label">Gate Departure</div>
              <div class="detail-value">
                <span>{dept_gate_actual.toFormat("h:mm a ZZZZ")}</span>
                <span class={`${dept_difference_class} time-saved`}>{dept_difference.minutes} minutes</span>
              </div>
            </div>
          </div>
          <div class="detail-item">
            <div class="icon">üõ¨</div>
            <div class="detail-content">
              <div class="detail-label">Gate Arrival</div>
              <div class="detail-value">
                <span>{arrival_gate_actual.toFormat("h:mm a ZZZZ")}</span>
                <span class={`${arrival_difference_class} time-saved`}>{arrival_difference.minutes} minutes</span>
              </div>
            </div>
          </div>
          {
            actual_time && (
              <div class="detail-item">
                <div class="icon">‚è±Ô∏è</div>
                <div class="detail-content">
                  <div class="detail-label">Duration</div>
                  <div class="detail-value">
                    {actual_time.hours}h {actual_time.minutes}m{" "}
                  </div>
                </div>
              </div>
            )
          }
        </div>
      </div>
    </div>
    <div class="map-container">
      <TripMap client:only="react" stops={stops} />
    </div>
    
  </div>
</Layout>

<style
  define:vars={{
    brandColor1: airline?.brand_color1,
    brandColor2: airline?.brand_color2,
    brandColor3: airline?.brand_color3,
  }}

  is:global
>
  .flights-container {
    max-width: 900px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin: 0 auto;
  }
  .airline-header {
    background: var(--brandColor1);
    color: white;
    padding: 20px 30px;
    font-size: 24px;
    font-weight: normal;
    text-align: left;
    display: flex;
    justify-content: space-between;
  }
  .flights {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    margin: 20px auto;
    gap: 40px;
    padding: 0 30px;
    @media (width >= 700px) {
      flex-direction: row;
    }
  }
  .flight-line-container {
    display: block;
    flex: 1;
    position: relative;
    margin: 0 30px;
    height: 40px;

    .flight-line {
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 2px;
      background: #333;
    }

    .plane-icon {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(135deg);
      font-size: 24px;
      background: white;
      padding: 0 8px;
      @media (width >= 700px) {
        transform: translate(-50%, -50%) rotate(45deg);
      }
    }
  }

  .stripe-container {
    height: 40px;
    border-radius: 0 0 12px 12px;
    overflow: hidden;
    background-image: repeating-linear-gradient(
      45deg,
      var(--brandColor1) 0px,
      var(--brandColor1) 5px,
      white 5px,
      white 10px,
      var(--brandColor1) 10px,
      var(--brandColor1) 15px,
      white 15px,
      white 20px,
      var(--brandColor2) 20px,
      var(--brandColor2) 25px,
      white 25px,
      white 30px,
      var(--brandColor2) 30px,
      var(--brandColor2) 35px,
      white 35px,
      white 40px,
      var(--brandColor3) 40px,
      var(--brandColor3) 45px,
      white 45px,
      white 50px,
      var(--brandColor3) 50px,
      var(--brandColor3) 55px,
      white 55px,
      white 60px
    );
  }


  .details-container {
    max-width: 900px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin: 40px auto;
    overflow: hidden;

    .status-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;

      padding: 20px 32px;
      font-weight: 600;
      font-size: 18px;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);

      &.on-time {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
      }
      &.delayed {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
      }
    }

    .details-times {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 32px;
      padding: 24px 32px;

      h3 {
        text-align: left;
        margin: 0;
      }

      .detail-item {
        display: flex;
        align-items: flex-start;
        gap: 16px;
        margin-top: 16px;

        .icon {
          font-size: 24px;
          width: 40px;
          height: 40px;
          display: flex;
          align-items: center;
          justify-content: center;
          background: #f3f4f6;
          border-radius: 10px;
          flex-shrink: 0;
        }

        .detail-content {
          flex: 1;
        }

        .detail-label {
          font-size: 12px;
          color: #6b7280;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          font-weight: 600;
          margin-bottom: 4px;
        }

        .detail-value {
          font-size: 20px;
          color: #1f2937;
          font-weight: 600;
          display: flex;
          align-items: center;
          gap: 10px;
        }
        .time-saved {
          color: white;
          padding: 4px 10px;
          border-radius: 12px;
          font-size: 12px;
          &.on-time {
            background-color: #10b981;
          }
          &.delayed {
            background: #f59e0b;
          }
        }
      }
    }
  }

  .map-container {
    max-width: 900px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin: 40px auto;

    .map {
      width: 100%;
      height: 500px;
    }
  }

</style>
